<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Prompt Structure — Config</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="container">
    <h1>Prompt Structure — Config</h1>
    <p>Edit the prompt blocks below. The <strong>JanitorAI Default (Cannot change)</strong> block is immutable and acts as the placeholder for external inputs.</p>

    <div id="blocksList">Loading...</div>

    <hr />
    <h3>Add new block</h3>
    <input id="new_name" placeholder="Name (eg. 'Assistant Persona')" />
    <select id="new_role">
      <option value="system">system</option>
      <option value="user">user</option>
      <option value="assistant">assistant</option>
    </select>
    <textarea id="new_content" placeholder="Block content (string)"></textarea>
    <button id="btnAddBlock">Add block</button>

    <p><a href="/">Back to dashboard</a></p>
  </main>

  <script>
    const $ = id => document.getElementById(id);
    let proxyToken = localStorage.getItem('proxy_token') || null;
    if (!proxyToken) {
      alert('You must be logged in. Redirecting to home.');
      location.href = '/';
    }

    function escapeHtml(unsafe) {
      return unsafe
           .replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#039;");
    }

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      const r = await fetch(path, { headers: { 'Content-Type': 'application/json', ...headers }, body: opts.body ? JSON.stringify(opts.body) : undefined, method: opts.method || 'GET', credentials: 'include' });
      const isJson = r.headers.get('content-type')?.includes('application/json');
      const data = isJson ? await r.json() : await r.text();
      if (!r.ok) throw data;
      return data;
    }

    async function loadBlocks() {
      try {
        const data = await api('/api/config');
        const blocks = data.blocks || [];
        const html = blocks.map((b, i) => `
          <div class="block-item ${b.immutable ? 'immutable' : ''}">
            <div class="block-header">
              <strong>${escapeHtml(b.name)}</strong> (${b.role}) ${b.immutable ? '— Cannot edit' : ''}
            </div>
            <div class="block-content">
              ${b.immutable ? 
                `<div class="readonly">${escapeHtml(b.content)}</div>` :
                `<textarea data-id="${b.id}" data-field="content" class="block-textarea">${escapeHtml(b.content)}</textarea>`
              }
            </div>
            ${!b.immutable ? `
              <div class="block-actions">
                <input data-id="${b.id}" data-field="name" value="${escapeHtml(b.name)}" placeholder="Block name" />
                <select data-id="${b.id}" data-field="role">
                  <option value="system" ${b.role === 'system' ? 'selected' : ''}>system</option>
                  <option value="user" ${b.role === 'user' ? 'selected' : ''}>user</option>
                  <option value="assistant" ${b.role === 'assistant' ? 'selected' : ''}>assistant</option>
                </select>
                <button onclick="updateBlock(${b.id})">Update</button>
                <button onclick="deleteBlock(${b.id})" class="delete-btn">Delete</button>
              </div>
            ` : ''}
          </div>
        `).join('');
        $('blocksList').innerHTML = html || '<i>No blocks</i>';
      } catch (err) {
        console.error(err);
        $('blocksList').innerHTML = `<pre>${JSON.stringify(err, null, 2)}</pre>`;
      }
    }

    async function updateBlock(id) {
      const name = document.querySelector(`input[data-id="${id}"][data-field="name"]`).value;
      const role = document.querySelector(`select[data-id="${id}"][data-field="role"]`).value;
      const content = document.querySelector(`textarea[data-id="${id}"][data-field="content"]`).value;
      try {
        await api(`/api/config/${id}`, { method: 'PUT', body: { name, role, content } });
        loadBlocks();
      } catch (err) { alert(JSON.stringify(err)); }
    }

    async function deleteBlock(id) {
      if (!confirm('Delete this block?')) return;
      try {
        await api(`/api/config/${id}`, { method: 'DELETE' });
        loadBlocks();
      } catch (err) { alert(JSON.stringify(err)); }
    }

    window.onload = () => {
      loadBlocks();
      $('btnAddBlock').onclick = async () => {
        const name = $('new_name').value;
        const role = $('new_role').value;
        const content = $('new_content').value;
        try {
          await api('/api/config', { method: 'POST', body: { name, role, content } });
          $('new_name').value = '';
          $('new_content').value = '';
          loadBlocks();
        } catch (err) { alert(JSON.stringify(err)); }
      };
    };
  </script>
</body>
</html>