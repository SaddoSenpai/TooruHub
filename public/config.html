<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Prompt Structure — TooruHub</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .config-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1rem; }
    .tab-btn { background: #f1f1f1; border: 1px solid transparent; border-bottom: 0; padding: 10px 15px; cursor: pointer; font-size: 1em; }
    .tab-btn.active { background: #fff; border-color: #ddd; border-bottom: 1px solid #fff; margin-bottom: -1px; }
    .tab-btn.is-proxy-active { font-weight: bold; color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .config-actions { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .block-item, .add-block-form { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 1rem; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; transition: opacity 0.2s ease-in-out; }
    .block-header { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .block-title { flex: 1; font-size: 1.1em; }
    .block-actions { display: flex; gap: 0.5rem; align-items: center; }
    .block-actions .reorder-btns { display: flex; flex-direction: column; gap: 4px; margin-right: 0.5rem; }
    .block-actions .reorder-btns button { line-height: 1; padding: 2px 6px; }
    .edit-form { display: flex; flex-direction: column; gap: 0.75rem; }
    .edit-form .form-row { display: flex; gap: 0.5rem; }
    .edit-form .form-row input, .edit-form .form-row select { flex: 1; padding: 0.5rem; }
    .edit-form textarea { width: 100%; min-height: 150px; font-family: monospace; padding: 0.5rem; box-sizing: border-box; }
    .edit-form-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }
    .edit-form-actions .cancel-btn { background-color: #6c757d; color: white; }
    .block-item .edit-form { display: none; }
    .block-item.is-editing .block-header { display: none; }
    .block-item.is-editing .edit-form { display: flex; }
    .import-btn { position: relative; }
    .import-input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .active-indicator { font-size: 0.8em; color: #28a745; font-weight: bold; margin-left: auto; }
    .validation-error { color: #dc3545; font-weight: bold; border: 1px solid; padding: 0.5rem; margin-bottom: 1rem; }
    .save-config-btn { background-color: #28a745; color: white; }
    .save-config-btn:hover { background-color: #218838; }
    .discard-changes-btn { background-color: #6c757d; color: white; }
    .discard-changes-btn:hover { background-color: #5a6268; }
    
    .block-item.is-disabled { opacity: 0.5; }
    .block-item.is-disabled .block-title { text-decoration: line-through; }

    /* --- Modern Switch Toggle --- */
    .switch-toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
      flex-shrink: 0; /* Prevents the toggle from shrinking */
    }
    .switch-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc; /* Grey for inactive */
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
    }
    input:checked + .slider {
      background-color: #28a745; /* Green for active */
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #28a745;
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }
    .slider.round {
      border-radius: 34px;
    }
    .slider.round:before {
      border-radius: 50%;
    }
    /* --- End of Switch Styles --- */

    /* --- Global Settings Box (Mobile Responsive) --- */
    .global-settings {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 1rem;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between; /* Pushes items apart */
      flex-wrap: wrap; /* Allows wrapping on small screens */
      gap: 1rem;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Prompt Structure — TooruHub</h1>
    
    <div class="config-tabs" id="configTabs">
      <button class="tab-btn active" data-slot="1">Config 1</button>
      <button class="tab-btn" data-slot="2">Config 2</button>
      <button class="tab-btn" data-slot="3">Config 3</button>
    </div>

    <!-- Global Settings Section -->
    <div class="global-settings">
      <label for="showThinkTagsToggleInput">Show Deepseek Reasoner <code>&lt;think&gt;</code> tags in stream</label>
      <label class="switch-toggle">
        <input type="checkbox" id="showThinkTagsToggleInput">
        <span class="slider round"></span>
      </label>
    </div>
    <!-- End of Section -->

    <div id="tabContents">
      <div class="tab-content active" data-slot="1">
        <div class="config-actions">
          <button class="save-config-btn" disabled>Save Configuration</button>
          <button class="discard-changes-btn" disabled>Discard Changes</button>
          <button class="rename-btn">Rename</button>
          <button class="export-btn">Export</button>
          <button class="import-btn">Import <input type="file" class="import-input" accept=".json" /></button>
          <button class="set-active-btn">Set Active for TooruHub</button>
          <span class="active-indicator" style="display:none;">★ Active for TooruHub</span>
        </div>
        <p>Arrange and edit your prompt blocks. Your config MUST contain these five placeholders in its ENABLED blocks: <code>&lt;&lt;CHARACTER_INFO&gt;&gt;</code>, <code>&lt;&lt;SCENARIO_INFO&gt;&gt;</code>, <code>&lt;&lt;SUMMARY&gt;&gt;</code>, <code>&lt;&lt;USER_INFO&gt;&gt;</code>, and <code>&lt;&lt;CHAT_HISTORY&gt;&gt;</code>. Use <code>{{char}}</code> for the character's name.</p>
        <div class="blocksList">Loading...</div>
      </div>
      <div class="tab-content" data-slot="2">
        <div class="config-actions">
          <button class="save-config-btn" disabled>Save Configuration</button>
          <button class="discard-changes-btn" disabled>Discard Changes</button>
          <button class="rename-btn">Rename</button>
          <button class="export-btn">Export</button>
          <button class="import-btn">Import <input type="file" class="import-input" accept=".json" /></button>
          <button class="set-active-btn">Set Active for TooruHub</button>
          <span class="active-indicator" style="display:none;">★ Active for TooruHub</span>
        </div>
        <p>Arrange and edit your prompt blocks...</p>
        <div class="blocksList">Loading...</div>
      </div>
      <div class="tab-content" data-slot="3">
        <div class="config-actions">
          <button class="save-config-btn" disabled>Save Configuration</button>
          <button class="discard-changes-btn" disabled>Discard Changes</button>
          <button class="rename-btn">Rename</button>
          <button class="export-btn">Export</button>
          <button class="import-btn">Import <input type="file" class="import-input" accept=".json" /></button>
          <button class="set-active-btn">Set Active for TooruHub</button>
          <span class="active-indicator" style="display:none;">★ Active for TooruHub</span>
        </div>
        <p>Arrange and edit your prompt blocks...</p>
        <div class="blocksList">Loading...</div>
      </div>
    </div>

    <hr />
    <h3>Add new block</h3>
    <div id="addBlockBox" class="add-block-form">
      <div class="form-row">
        <input id="new_name" placeholder="Name (eg. 'Jailbreak')" />
        <select id="new_role">
          <option value="system">system</option>
          <option value="user">user</option>
          <option value="assistant">assistant</option>
        </select>
      </div>
      <textarea id="new_content" placeholder="Block content (string). Use {{char}} for the character's name."></textarea>
      <div class="edit-form-actions">
        <button id="btnAddBlock">Add block to draft</button>
      </div>
    </div>

    <p><a href="/">Back to dashboard</a></p>
  </main>

  <script>
    const $ = id => document.getElementById(id);
    let proxyToken = localStorage.getItem('proxy_token') || null;
    if (!proxyToken) {
      alert('You must be logged in. Redirecting to home.');
      location.href = '/';
    }

    let activeTab = 1;
    let proxyActiveSlot = 1;
    let configNames = ['Config 1', 'Config 2', 'Config 3'];
    
    let savedBlocksBySlot = { 1: [], 2: [], 3: [] };
    let draftBlocksBySlot = { 1: [], 2: [], 3: [] };

    const REQUIRED_PLACEHOLDERS = ['<<CHARACTER_INFO>>', '<<SCENARIO_INFO>>', '<<SUMMARY>>', '<<USER_INFO>>', '<<CHAT_HISTORY>>'];

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      if (!opts.isFormData) headers['Content-Type'] = 'application/json';
      headers['Authorization'] = 'Bearer ' + proxyToken;
      
      const r = await fetch(path, { 
        headers, 
        body: opts.isFormData ? opts.body : (opts.body ? JSON.stringify(opts.body) : undefined), 
        method: opts.method || 'GET' 
      });

      const contentType = r.headers.get('content-type');
      if (contentType && contentType.includes('application/json') && !opts.isExport) {
        const data = await r.json();
        if (!r.ok) throw data;
        return data;
      }
      
      if (!r.ok) throw await r.text();
      return r;
    }

    function validateConfig(blocks) {
        const enabledBlocks = blocks.filter(b => b.is_enabled);
        const fullContent = enabledBlocks.map(b => b.content || '').join('');
        const missing = REQUIRED_PLACEHOLDERS.filter(p => !fullContent.includes(p));
        return missing;
    }

    function checkForUnsavedChanges(slot) {
        const hasChanges = JSON.stringify(savedBlocksBySlot[slot]) !== JSON.stringify(draftBlocksBySlot[slot]);
        const tabContent = document.querySelector(`.tab-content[data-slot="${slot}"]`);
        tabContent.querySelector('.save-config-btn').disabled = !hasChanges;
        tabContent.querySelector('.discard-changes-btn').disabled = !hasChanges;
    }

    function renderBlocks(slot) {
        const container = document.querySelector(`.tab-content[data-slot="${slot}"] .blocksList`);
        const currentBlocks = draftBlocksBySlot[slot] || [];
        let html = '';

        const missing = validateConfig(currentBlocks);
        if (missing.length > 0) {
            const escapedMissing = missing.map(p => p.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join(', ');
            html += `<div class="validation-error"><strong>Invalid Configuration!</strong> Missing required placeholder(s) in ENABLED blocks:<br><code>${escapedMissing}</code></div>`;
        }

        if (currentBlocks.length === 0) {
            html += '<i>No blocks for this config. Add one below or import a config.</i>';
        } else {
            html += currentBlocks.map((b, index) => `
            <div class="block-item ${!b.is_enabled ? 'is-disabled' : ''}" data-index="${index}">
              <div class="block-header">
                <label class="switch-toggle" title="Enable/Disable Block">
                  <input type="checkbox" class="enable-toggle" ${b.is_enabled ? 'checked' : ''}>
                  <span class="slider round"></span>
                </label>
                <div class="block-title"><strong>${b.name}</strong> <small>(${b.role})</small></div>
                <div class="block-actions">
                  <div class="reorder-btns"><button class="up-btn">↑</button><button class="down-btn">↓</button></div>
                  <button class="edit-btn">Edit</button><button class="del-btn">Delete</button>
                </div>
              </div>
              <div class="edit-form">
                <div class="form-row"><input class="edit-name" value="${b.name}"/><select class="edit-role"><option value="system" ${b.role === 'system' ? 'selected' : ''}>system</option><option value="user" ${b.role === 'user' ? 'selected' : ''}>user</option><option value="assistant" ${b.role === 'assistant' ? 'selected' : ''}>assistant</option></select></div>
                <textarea class="edit-content" placeholder="Block content">${b.content || ''}</textarea>
                <div class="edit-form-actions"><button class="cancel-btn">Cancel</button><button class="save-btn">Save</button></div>
              </div>
            </div>`).join('');
        }

        container.innerHTML = html;
        attachBlockEventListeners(slot);
        checkForUnsavedChanges(slot);
    }

    function attachBlockEventListeners(slot) {
      document.querySelectorAll(`.tab-content[data-slot="${slot}"] .block-item`).forEach(blockEl => {
        const index = parseInt(blockEl.dataset.index, 10);
        
        blockEl.querySelector('.enable-toggle').onclick = (ev) => {
            draftBlocksBySlot[slot][index].is_enabled = ev.target.checked;
            renderBlocks(slot);
        };

        blockEl.querySelector('.up-btn').onclick = () => {
            if (index > 0) {
                [draftBlocksBySlot[slot][index], draftBlocksBySlot[slot][index - 1]] = [draftBlocksBySlot[slot][index - 1], draftBlocksBySlot[slot][index]];
                renderBlocks(slot);
            }
        };
        blockEl.querySelector('.down-btn').onclick = () => {
            if (index < draftBlocksBySlot[slot].length - 1) {
                [draftBlocksBySlot[slot][index], draftBlocksBySlot[slot][index + 1]] = [draftBlocksBySlot[slot][index + 1], draftBlocksBySlot[slot][index]];
                renderBlocks(slot);
            }
        };
        blockEl.querySelector('.del-btn').onclick = () => {
          if (!confirm('Delete this block from your draft?')) return;
          draftBlocksBySlot[slot].splice(index, 1);
          renderBlocks(slot);
        };
        blockEl.querySelector('.edit-btn').onclick = () => blockEl.classList.add('is-editing');
        blockEl.querySelector('.cancel-btn').onclick = () => blockEl.classList.remove('is-editing');
        
        blockEl.querySelector('.save-btn').onclick = () => {
          const newName = blockEl.querySelector('.edit-name').value;
          const newRole = blockEl.querySelector('.edit-role').value;
          const newContent = blockEl.querySelector('.edit-content').value;
          draftBlocksBySlot[slot][index] = { ...draftBlocksBySlot[slot][index], name: newName, role: newRole, content: newContent };
          blockEl.classList.remove('is-editing');
          renderBlocks(slot);
        };
      });
    }

    async function loadBlocks(slot) {
      try {
        const { blocks } = await api(`/api/config?slot=${slot}`);
        savedBlocksBySlot[slot] = JSON.parse(JSON.stringify(blocks));
        draftBlocksBySlot[slot] = JSON.parse(JSON.stringify(blocks));
        renderBlocks(slot);
      } catch (err) {
        console.error(err);
        document.querySelector(`.tab-content[data-slot="${slot}"] .blocksList`).innerHTML = `<pre>Error loading blocks: ${JSON.stringify(err, null, 2)}</pre>`;
      }
    }

    async function loadConfigMeta() {
        const meta = await api('/api/configs/meta');
        configNames = [meta.config_name_1, meta.config_name_2, meta.config_name_3];
        proxyActiveSlot = meta.active_config_slot;

        // Set the new global toggle state
        $('showThinkTagsToggleInput').checked = meta.show_think_tags;

        document.querySelectorAll('.tab-btn').forEach((btn, i) => {
            btn.textContent = configNames[i] || `Config ${i+1}`;
            btn.classList.toggle('is-proxy-active', (i + 1) == proxyActiveSlot);
        });
        document.querySelectorAll('.tab-content').forEach((content, i) => {
            const slot = i + 1;
            content.querySelector('.set-active-btn').style.display = (slot == proxyActiveSlot) ? 'none' : 'inline-block';
            content.querySelector('.active-indicator').style.display = (slot == proxyActiveSlot) ? 'inline-block' : 'none';
        });
    }

    function switchTab(slot) {
        activeTab = slot;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.slot == slot));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.dataset.slot == slot));
        
        if (savedBlocksBySlot[slot].length === 0 && draftBlocksBySlot[slot].length === 0) {
            loadBlocks(slot);
        } else {
            renderBlocks(slot);
        }
    }

    function attachGlobalEventListeners() {
        $('showThinkTagsToggleInput').onchange = async (ev) => {
            try {
                await api('/api/configs/settings', {
                    method: 'PUT',
                    body: { show_think_tags: ev.target.checked }
                });
                // Optional: add a small success indicator
            } catch (err) {
                alert('Failed to save setting: ' + JSON.stringify(err));
                // Revert toggle on failure
                ev.target.checked = !ev.target.checked;
            }
        };

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => switchTab(btn.dataset.slot);
        });

        document.querySelectorAll('.tab-content').forEach(tabContent => {
            const slot = tabContent.dataset.slot;

            tabContent.querySelector('.save-config-btn').onclick = async () => {
                const missing = validateConfig(draftBlocksBySlot[slot]);
                if (missing.length > 0) {
                    alert(`Cannot save. Configuration is invalid.\nMissing from enabled blocks: ${missing.join(', ')}`);
                    return;
                }
                try {
                    const { blocks } = await api(`/api/config/slot/${slot}`, { method: 'PUT', body: { blocks: draftBlocksBySlot[slot] } });
                    savedBlocksBySlot[slot] = JSON.parse(JSON.stringify(blocks));
                    draftBlocksBySlot[slot] = JSON.parse(JSON.stringify(blocks));
                    renderBlocks(slot);
                    alert('Configuration saved successfully!');
                } catch (err) {
                    alert('Failed to save configuration: ' + JSON.stringify(err));
                }
            };

            tabContent.querySelector('.discard-changes-btn').onclick = () => {
                if (!confirm('Are you sure you want to discard all unsaved changes?')) return;
                draftBlocksBySlot[slot] = JSON.parse(JSON.stringify(savedBlocksBySlot[slot]));
                renderBlocks(slot);
            };
            
            tabContent.querySelector('.rename-btn').onclick = async () => {
                const currentName = configNames[slot - 1];
                const newName = prompt(`Enter new name for "${currentName}":`, currentName);
                if (newName && newName !== currentName) {
                    configNames[slot - 1] = newName;
                    await api('/api/configs/meta', { method: 'PUT', body: { names: configNames } });
                    await loadConfigMeta();
                }
            };
            tabContent.querySelector('.set-active-btn').onclick = async () => {
                await api('/api/configs/active', { method: 'PUT', body: { slot: parseInt(slot, 10) } });
                await loadConfigMeta();
            };
            tabContent.querySelector('.export-btn').onclick = async () => {
                const exportData = { configName: configNames[slot-1], blocks: draftBlocksBySlot[slot].map(b => ({ name: b.name, role: b.role, content: b.content, is_enabled: b.is_enabled })) };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${configNames[slot-1].replace(/ /g, '_')}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            };
            tabContent.querySelector('.import-input').onchange = async (ev) => {
                const file = ev.target.files[0];
                if (!file) return;
                if (!confirm(`This will overwrite your current DRAFT for "${configNames[slot-1]}". Are you sure?`)) {
                    ev.target.value = '';
                    return;
                }
                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);
                    if (!importData.configName || !Array.isArray(importData.blocks)) throw new Error('Invalid JSON format');
                    
                    const blocksToImport = importData.blocks.map(b => ({
                        ...b,
                        is_enabled: b.is_enabled !== false
                    }));

                    const missing = validateConfig(blocksToImport);
                    if (missing.length > 0) {
                        if (!confirm(`Warning: The imported config is missing required placeholders in its enabled blocks: ${missing.join(', ')}.\n\nDo you want to import it anyway?`)) {
                            ev.target.value = '';
                            return;
                        }
                    }
                    
                    draftBlocksBySlot[slot] = blocksToImport;
                    configNames[slot-1] = importData.configName;
                    document.querySelector(`.tab-btn[data-slot="${slot}"]`).textContent = importData.configName;
                    renderBlocks(slot);
                } catch (err) {
                    alert('Import failed: ' + err.message);
                } finally {
                    ev.target.value = '';
                }
            };
        });

        $('btnAddBlock').onclick = () => {
            const name = $('new_name').value;
            const role = $('new_role').value;
            const content = $('new_content').value;
            if (!name) {
              alert('Block name is required.');
              return;
            }
            draftBlocksBySlot[activeTab].push({ name, role, content, is_enabled: true });
            $('new_name').value = '';
            $('new_content').value = '';
            renderBlocks(activeTab);
        };
    }

    window.onload = async () => {
      try {
        await loadConfigMeta();
        attachGlobalEventListeners();
        switchTab(1);
      } catch (err) {
        console.error("Failed to initialize config page:", err);
        const container = document.querySelector('.tab-content.active .blocksList');
        if(container) container.innerHTML = `<pre>Fatal Error: Could not load configuration metadata. Please check the console for details.\n\n${JSON.stringify(err, null, 2)}</pre>`;
      }
    };
  </script>
</body>
</html>